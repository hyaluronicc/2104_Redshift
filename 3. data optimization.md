# 쿼리 분석_query profiling

리더 노드 : 실행계획 생성하는 쿼리 플래닝
<br>

## 쿼리 플래닝
레드시프트 리더 노드가 컴퓨팅 노드에 작업 요청 전 쿼리 분석 및 최적화. 

1. 클라이언트가 리더 노드에 연결해 쿼리 실행
2. 리더 노드 파서 : 쿼리 파싱, 쿼리 문법에 문제 없는지 확인 -> 쿼리 트리 생성 및 옵티마이저에 전달
3. 옵티마이저: 쿼리 트리 최적화된 구조로 재구성, 시스템 테이블의 통계정보 이용해 실행 계획 작성
4. 실행 엔진: 실행 계획이 전달됨. 각 트리 노드를 스텝, 세그먼트, 스트림 3가지 단위로 분리.
5. 1번째 스트림을 선택해 세그먼트 단위로 C++ 컴파일 코드 생성. 컴퓨팅 노드에서 실행. 
6. 컴파일 코드가 컴퓨팅 노드에 전달된 뒤 리더 노드의 캐시 메모리에 LRU(Least-Recently-Used) 방식으로 저장. 
7. 세그먼트는 컴퓨팅 노드의 WLM 쿼리 슬롯을 통해 병렬로 실행. 쿼리 슬롯 단위로 독립적인 프로세스 생성하고 프로세스ID를 부여받음. 각 프로세스는 하나씩의 세그먼트 담당
8. 스트림의 모든 세그먼트 작업이 완료되면 다음 스트림의 세그먼트 컴파일. 앞에서 실행된 세그먼트 작업 결과와 성능을 분석 후 다음 세그먼트 최적화하기 위함
9. 컴퓨팅 노드에서 모든 스트림 작업이 끝나면 리더 노드에게 결과 데이터 전송
10. 리더 노드는 전달받은 결과 데이터 취합 후 정렬, 집계, limit 등 마무리 작업 후 클라이언트에 전달

